function [wp, is_values] = weno15(u_values, u_idx, n, epsilon, p)

	persistent stencil_mapping;
	persistent local_flux_values;
	persistent all_smooth;

	% Coefficients for the interpolant of each stencil
	stencil_coeffs = [   -105,     15,    -5,     3,    -3,    5,   -15,    105;
                         855,   -125,    43,   -27,    29,  -55,   225,   1443;
                       -3065,    463,  -167,   113,  -139,  365,  1023,  -1497;
                        6343,  -1007,   393,  -307,   533,  743,  -657,   1443;
                       -8357,   1443,  -657,   743,   533, -307,   393,  -1007;
                        7323,  -1497,  1023,   365,  -139,  113,  -167,    463;
                       -4437,   1443,   225,   -55,    29,  -27,    43,   -125;
                        2283,    105,   -15,     5,    -3,    3,    -5,     15] ./ 840;
	
	% Weights representing the ideal linear combination of stencils
	ideal_weights = [1/6453, 56/6435, 196/2145, 392/1287, 490/1287, 392/2145, 196/6435, 8/6435];

	% Coefficients for use in the smoothness calculation
	smoothness_coeffs{1} = [[ 986005096387/20756736000;
              -1410106709147/1945944000;
              10610581100123/4447872000;
              -3423798156193/778377600;
              10196716797013/2075673600;
              -6476591199161/1945944000;
              39509061792127/31135104000;
              -819100494587/3891888000    ],...
            [              0.;
              172229708657639/62270208000; 
              -70944310593109/3891888000;
              41910140004779/1245404160;
              -4882688924777/129729600;
              795325997722517/31135104000;
              -12661520644021/1297296000;
              50528822994577/31135104000 ],...
            [               0.;
                            0.;
              624177436330267/20756736000;
              -983492927359/8845200;
              775760249154827/6227020800;
              -109928049802589/1297296000;
              1010731494899387/31135104000;
              -5269260407953/972972000    ],...
            [               0.;
                            0.;
                            0.;
                23315424178373/226437120;
              -35999233471051/155675520;
              982150494698309/6227020800;
              -393303816739/6486480;
              7028987165449/691891200 ],...
            [               0.;
                            0.;
                            0.;
                            0.;
               5896382977423/45287424;
              -6306477584539/35380800;
              428668917728281/6227020800;
              -9030771744409/778377600 ],...
            [               0.;
                            0.;
                            0.;
                            0.;
                            0.;
              1272280750118197/20756736000;
              -185432400549349/3891888000;
              36019630238453/4447872000 ],...
            [               0.;
                            0.;
                            0.;
                            0.;
                            0.;
                            0.;
              581791881407369/62270208000;
              -3130718954431/972972000   ],...
            [               0.;
                            0.;
                            0.;
                            0.;
                            0.;
                            0.;
                            0.;
              5870785406797/20756736000 ] ];
 
 smoothness_coeffs{2} = [ [ 26446172491/2965248000;
                -132173819131/972972000;
                13873328286131/31135104000;
                -90744192823/111196800;
                41566759079/46126080;
                -583488131053/972972000;
                6925711076497/31135104000;
                -137801870867/3891888000 ],...
              [                0.;
                 32268504444809/62270208000;
                -13257668940469/3891888000;
                38941083744793/6227020800;
                -224563041869/32432400;
                143887855797947/31135104000;
                -2230862726341/1297296000;
                1221480056521/4447872000 ],...
              [             0.; 
                            0.;
               116487285372277/20756736000;
                -29244985495/1415232;
                142950967195973/6227020800;
                -19952704102349/1297296000;
                178922840432597/31135104000;
                -1793558121581/1945944000 ],...
              [              0.;
                             0.;
                             0.;
                 4322531771339/226437120;
                -6630479776771/155675520;
                178559835040523/6227020800;
                -1397571412901/129729600;
                721470910481/415134720 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                5407733702789/226437120;
                -11450077957/353808;
                76273513229143/6227020800;
                -1550584925161/778377600 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                229456135916827/20756736000;
                -32903428273669/3891888000;
                43315366304381/31135104000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                102080471419559/62270208000;
                -1069457397287/1945944000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                 986005096387/20756736000 ]];
              
  smoothness_coeffs{3} = [[ 46388292547/20756736000;
                -65611168187/1945944000;
                3388533713021/31135104000;
                -151441370209/778377600;
                431000077397/2075673600;
                -256879392281/1945944000;
                1438198790527/31135104000;
                -26674345787/3891888000 ],...
              [              0.;
                 7965255985319/62270208000;
                -3233549114749/3891888000;
                9306913817431/6227020800;
                -41643930661/25945920;
                31959522170837/31135104000;
                -468561665821/1297296000;
                1677021138577/31135104000 ],...
              [              0.;
                             0.;
                 28199161918747/20756736000;
                -5445142127/1105650;
                33191727291659/6227020800;
                -4456767285989/1297296000;
                37913679009467/31135104000;
                -25412164549/138996000 ],...
              [              0.;
                             0.;
                             0.;
                 203912134273/45287424;
                -1532094364651/155675520;
                39896100785477/6227020800;
                -37187936869/16216200;
                721220745563/2075673600 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                1231949387723/226437120;
                -253865691211/35380800;
                3240510296069/1245404160;
                -310726966393/778377600 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                49883478342517/20756736000;
                -6905100758509/3891888000;
                8624638348211/31135104000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                20863031646089/62270208000;
                -104391937861/972972000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                 26446172491/2965248000 ]];
              
 smoothness_coeffs{4} = [[  25116366157/20756736000;
                -2407377043/138996000;
                1631589107891/31135104000;
                -67513265377/778377600;
                25116366157/296524800;
                -47469340603/972972000;
                478185649297/31135104000;
                -7942541267/3891888000 ],...
              [              0.;
                 3944861897609/62270208000;
                -1521688484269/3891888000;
                4100880843289/6227020800;
                -10590149653/16216200;
                11870432980667/31135104000;
                -157580595421/1297296000;
                508082860927/31135104000 ],...
              [              0.;
                             0.;
                12780967457077/20756736000;
                -74851467823/35380800;
                532071643661/249080832;
                -1644079167749/1297296000;
                12752830987157/31135104000;
                -108473646221/1945944000 ],...
              [              0.;
                             0.;
                             0.;
                 420341161931/226437120;
                -595915721251/155675520;
                14416393946891/6227020800;
                -98765696693/129729600;
                72812006087/691891200 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                457249528517/226437120;
                -5527715497/2211300;
                5227966881367/6227020800;
                -18415814357/155675520 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.; 
               16476387815707/20756736000;
                -2129103852829/3891888000;
                2458417783421/31135104000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                6047605530599/62270208000;
                -56245265927/1945944000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                46388292547/20756736000]];
              
  smoothness_coeffs{5} = [[ 46388292547/20756736000;
                -56245265927/1945944000;
                2458417783421/31135104000;
                -18415814357/155675520;
                72812006087/691891200;
                -108473646221/1945944000;
                508082860927/31135104000;
                -7942541267/3891888000 ],...
              [              0.;
                6047605530599/62270208000;
                -2129103852829/3891888000;
                5227966881367/6227020800;
                -98765696693/129729600;
                12752830987157/31135104000;
                -157580595421/1297296000;
                478185649297/31135104000],...
              [              0.;
                             0.;
                16476387815707/20756736000;
                -5527715497/2211300;
                14416393946891/6227020800;
                -1644079167749/1297296000;
                11870432980667/31135104000;
                -47469340603/972972000 ],...
              [              0.;
                             0.;
                             0.;
                 457249528517/226437120;
                -595915721251/155675520;
                532071643661/249080832;
                -10590149653/16216200;
                25116366157/296524800 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                420341161931/226437120;
                -74851467823/35380800;
                4100880843289/6227020800;
                -67513265377/778377600 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                12780967457077/20756736000;
                -1521688484269/3891888000;
                1631589107891/31135104000 ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                3944861897609/62270208000;
                -2407377043/138996000; ],...
              [              0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                25116366157/20756736000 ] ];
              
 smoothness_coeffs{6} = [[  26446172491/2965248000;
                -104391937861/972972000;
                8624638348211/31135104000;
                -310726966393/778377600;
                721220745563/2075673600;
                -25412164549/138996000;
                1677021138577/31135104000;
                -26674345787/3891888000 ],...
             [               0.;
                20863031646089/62270208000;
                -6905100758509/3891888000;
                3240510296069/1245404160;
                -37187936869/16216200;
                37913679009467/31135104000;
                -468561665821/1297296000;
                1438198790527/31135104000 ],...
             [               0.;
                             0.;
                49883478342517/20756736000;
                -253865691211/35380800;
                39896100785477/6227020800;
                -4456767285989/1297296000;
                31959522170837/31135104000;
                -256879392281/1945944000  ],...
             [               0.;
                             0.;
                             0.;
                1231949387723/226437120;
                -1532094364651/155675520;
                33191727291659/6227020800;
                -41643930661/25945920;
                431000077397/2075673600 ],...
             [               0.;
                             0.;
                             0.;
                             0.;
                 203912134273/45287424;
               -5445142127/1105650;
               9306913817431/6227020800;
               -151441370209/778377600 ],...
             [               0.;
                             0.;
                             0.;
                             0.;
                             0.;
               28199161918747/20756736000;
               -3233549114749/3891888000;
               3388533713021/31135104000 ],... 
             [               0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
               7965255985319/62270208000;
               -65611168187/ 1945944000 ],...
             [               0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
               46388292547/20756736000 ] ];
             
 smoothness_coeffs{7} = [[ 986005096387/20756736000;
               -1069457397287/1945944000;
               43315366304381/31135104000;
               -1550584925161/778377600;
               721470910481/415134720;
               -1793558121581/1945944000;
               1221480056521/4447872000;
               -137801870867/3891888000 ],...
            [                0.;
              102080471419559/62270208000;
              -32903428273669/3891888000;
              76273513229143/6227020800;
              -1397571412901/129729600;
              178922840432597/31135104000;
              -2230862726341/1297296000;
              6925711076497/31135104000 ],...
            [                0.;
                             0.;
              229456135916827/20756736000;
              -11450077957/353808;
              178559835040523/6227020800;
              -19952704102349/1297296000;
              143887855797947/31135104000;
              -583488131053/972972000  ],...
            [                0.;
                             0.;
                             0.;
              5407733702789/226437120;
              -6630479776771/155675520;
              142950967195973/6227020800;
              -224563041869/32432400;
              41566759079/46126080     ],...
            [                0.;
                             0.;
                             0.;
                             0.;
               4322531771339/226437120;
              -29244985495/1415232;
              38941083744793/6227020800;
              -90744192823/111196800    ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
              116487285372277/20756736000;
              -13257668940469/3891888000;
              13873328286131/31135104000   ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
              32268504444809/62270208000;
              -132173819131/972972000    ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
              26446172491/2965248000   ]];
            
 smoothness_coeffs{8} =[[ 5870785406797/20756736000;
              -3130718954431/972972000;
              36019630238453/4447872000;
              -9030771744409/778377600;
              7028987165449/691891200;
              -5269260407953/972972000;
              50528822994577/31135104000;
              -819100494587/3891888000    ],...
            [               0.;
              581791881407369/62270208000;
              -185432400549349/3891888000;
              428668917728281/6227020800;
              -393303816739/6486480;
              1010731494899387/31135104000;
              -12661520644021/1297296000;
              39509061792127/31135104000   ],...
            [                0.;
                             0.;
              1272280750118197/20756736000;
              -6306477584539/35380800;
              982150494698309/6227020800;
              -109928049802589/1297296000;
              795325997722517/31135104000;
              -6476591199161/1945944000   ],...
            [                0.;
                             0.;
                             0.;
              5896382977423/45287424;
              -35999233471051/155675520;
              775760249154827/6227020800;
              -4882688924777/129729600;
              10196716797013/2075673600   ],...
            [                0.;
                             0.;
                             0.;
                             0.;
              23315424178373/226437120;
              -983492927359/8845200;
              41910140004779/1245404160;
              -3423798156193/778377600;     ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
              624177436330267/20756736000;
              -70944310593109/3891888000;
              10610581100123/4447872000   ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
              172229708657639/62270208000;
              -1410106709147/1945944000   ],...
            [                0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
                             0.;
              986005096387/20756736000 ]];

	% Create a block-diagonal matrix of smoothness coefficients
	if isempty(all_smooth)
		all_smooth = blkdiag(smoothness_coeffs{:});
	end
      
	m = 8;
	u_values = u_values';
	n_points = numel(u_idx);
	
	% Initialize the transposed flux-interpolation matrix.
	%
	wp = zeros(n, n_points);
	%
	% Normally it would be an (n_points x n) sized matrix, with each row 
	% interpolating the flux at x_{i-1/2} using function values at our 
	% grid points, but it's more efficient to construct it column-wise 
	% than row-wise, so we'll be operating on the transpose.
	% 
	
	% Initialize Smoothness Measurements
	ISp = zeros(1,m);
	nonlinear_values = zeros(m,m);

	
	% Generate stencil indices
	%
	stencils = zeros(m,m);
	stencils(:,1) = (1:m)';
	for i=2:m
		stencils(:,i) = stencils(:,i-1) + 1;
	end
	%
	% 'stencils' is an (m x m) matrix where each column contains the
	% relative indices (1;2;3..., 2,3,4....) for each stencil. 
	% 
	
	% 'local_flux_values' is a matrix used to collect the local flux
	% interpolation values so that they can easily be summed and
	% incorporated into a row of the global flux interpolation matrix.
	if isempty(local_flux_values)
		local_flux_values = zeros(m+(m-1));
		for i=1:m
			stencil_mapping(:, i) = sub2ind(size(local_flux_values), i*ones(1,m), (1:m)+(i-1));
		end
	end
	
	% Define a local index for our points
	j_absidx = 1;
	% 
	% 'j_absidx' references the local index of function values in 'u_values'
	% for constructing rows in the flux interpolation matrix.
	
	for j=u_idx

		% Get the global indices of the current point.
		window = (j-7:j+7)';
		
		% Get the corresponding function values.
		u = u_values(window);
		
		% Map the function values into local stencils.
		u_local = u(stencils);
		
		% Calculate the smoothness of each stencil.
		nonlinear_values(:) = (u_local(:).*(all_smooth*u_local(:)));
		ISp = sum(nonlinear_values,1);
		%
		% It's surprisingly efficient to just flatten 'u_local' and
		% multiply it by our block matrix of smoothness coefficients though
		% for higher-order weno methods the size of 'all_smooth' should
		% be taken into account and the matrix stored sparsely.
		% 
		
		% Calculate the normalized weights of each stencil.
		ISp = ideal_weights ./ (ISp + epsilon).^p;
		ISp = ISp ./ norm(ISp,1);
		%
		% norm(x,1) is noticably faster than sum(x) but
		% it should be noted that their results can differ
		% by what's hopefully just an insignificant rounding
		% error. If this is a problem, replace with:
		%
  		% IS = IS / sum(IS);  
  		% 

		% Apply those weights to each stencil.
		interp_coeffs = bsxfun(@times, stencil_coeffs, ISp);

		% Map global indices into our local stencils
		window_indices = window(stencils);
		
		% Update the global flux-interpolation matrix with our local stencils
		local_flux_values(stencil_mapping) = interp_coeffs;
		wp(window_indices(1):window_indices(end), j_absidx) = sum(local_flux_values);

		% Move on to the next row of the global flux-interpolation matrix.
		j_absidx = j_absidx + 1;
	end
	
	% Return a correctly-transposed matrix.
	wp = wp';
end