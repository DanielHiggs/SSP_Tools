function [wp, is_values] = weno13(u_values, u_idx, n, epsilon, p)

	persistent stencil_mapping;
	persistent local_flux_values;
	persistent all_smooth;
	
	% Coefficients for the interpolant of each stencil
	stencil_coeffs = [ 60,  -10,    4,   -3,    4,  -10,   60;
					-430,   74,  -31,   25,  -38,  130,  669;
					1334, -241,  109, -101,  214,  459, -591;
					-2341,  459, -241,  319,  319, -241,  459;
					2559, -591,  459,  214, -101,  109, -241;
					-1851,  669,  130,  -38,   25,  -31,   74;
					1089,   60,  -10,    4,   -3,    4,  -10 ] ./420;
	
	% Weights representing the ideal linear combination of stencils
	ideal_weights = [1/1716, 7/286, 105/572, 175/429, 175/572, 21/286, 7/1716];

	% Coefficients for use in the smoothness calculation
	smoothness_coeffs{1} = [[    62911297 / 2993760,...
						-5556669277 / 19958400,...
						15476926351 / 19958400,...
						-17425032203 / 14968800,...
						4964771899 / 4989600,... 
						-9181961959 / 19958400,...
						5391528799 / 59875200 ]',......
						[           0,...
							2047941883 / 2217600,...
							-3809437823 / 739200,... 
							38683385051 / 4989600,...
							-14734178999 / 2217600,... 
							3417057367 / 1108800,... 
							-2416885043 / 3991680 ]',......
						[             0,...
											0,...
								199730921 / 27720,...
							-21693002767 / 997920,...
							8290771913 / 443520,...
							-19308505679 / 2217600,...
							8579309749 / 4989600]',......
						[             0.,...
											0.,...
											0.,...
							49256859919 / 2993760,...
							-28364892607 / 997920,...
							66440049371 / 4989600,...
							-39645439643 / 14968800 ]',......
						[             0.,...
											0.,...
											0.,...
											0.,...
							1369404749 / 110880,...
							-8623431623 / 739200,...
							46808583631 / 19958400 ]',......
						[             0.,...
											0.,...
											0.,...
											0.,...
											0.,...
							6182612731 / 2217600,...
							-22763092357 / 19958400 ]',......
						[             0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								897207163 / 7484400 ]'];

	smoothness_coeffs{2} = [[         64361771 / 14968800,...
								-377474689 / 6652800,... 
								3126718481 / 19958400,...
								-3465607493 / 14968800,...
								320782183 / 1663200,...
								-341910757 / 3991680,... 
								945155329 / 59875200 ]',... 
							[             0.,...
								1250007643 / 6652800,...
								-6932480657 / 6652800,...
								857838469 / 554400,...
								-8619440987 / 6652800,...
								1924032511 / 3326400,...
								-712745603 / 6652800  ]',...
							[             0.,...    
											0.,...
									53678683 / 36960,...
								-4330640057 / 997920,... 
								4868089189 / 1330560,... 
								-405382961 / 246400,... 
								1531307249 / 4989600  ]',...
							[             0.,...
											0.,...
											0.,...
								9780057169 / 2993760,...
								-616410313 / 110880,...
								12601009501 / 4989600,...
								-7124638253 / 14968800 ]',...
							[             0.,...
											0.,...
											0.,...
											0.,...
								796358777 / 332640,...
							-14684933057 / 6652800,...
								2811067067 / 6652800  ]',...
							[             0.,...    
											0.,...
											0.,...
											0.,...
											0.,...
								127942497 / 246400,...
								-4074544787 / 19958400 ]',...
							[             0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								62911297 / 2993760  ]' ];

	smoothness_coeffs{3} = [    [     2627203 / 1871100,... 
								-359321429 / 19958400,...
								105706999 / 2217600,...
								-995600723 / 14968800,...
								256556849 / 4989600,...
								-15401629 / 739200,... 
									8279479 / 2395008  ]',...
							[             0.,...
								130013563 / 2217600,...
							-2096571887 / 6652800,...
								2224538011 / 4989600,...
								-773749439 / 2217600,...
								475321093 / 3326400,...
								-95508139 / 3991680  ]',...
							[             0.,...
											0.,...
								143270957 / 332640,...
								-412424029 / 332640,...
								1312114459 / 1330560,...
							-2725575317 / 6652800,...
								115524053 / 1663200  ]',...
							[            0.,...
											0.,...
											0.,...                      
								2726585359 / 2993760,...
							-1476618887 / 997920,...
								1042531337 / 1663200,...
							-1618284323 / 14968800 ]',...
							[           0.,...
											0.,...
											0.,...                      
											0.,...
								34187317 / 55440,...
							-3573798407 / 6652800,... 
								1894705391 /19958400  ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								806338417 / 6652800,...
								-295455983 / 6652800  ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								64361771 / 14968800  ]'];
								
	smoothness_coeffs{4} = [ [        2627203 / 1871100,...
								-323333323 / 19958400,...
								761142961 / 19958400,...
								-701563133 / 14968800,...
								158544319 / 4989600,...
								-225623953 / 19958400,...
								99022657 / 59875200 ]',...
							[            0.,...
								108444169 / 2217600,...
								-176498513 / 739200,...
								1506944981 / 4989600,...
								-464678369 / 2217600,...
								84263749 / 1108800,...
								-225623953 / 19958400   ]',...
							[            0.,...
											0.,...
								16790707 / 55440,...
								-790531177 / 997920,...
								250523543 / 443520,...
								-464678369 / 2217600,...
								158544319 / 4989600    ]',...
							[            0.,...
											0.,...
											0.,...
								1607739169 / 2993760,...
								-790531177 / 997920,...
								1506944981 / 4989600,...
								-701563133 / 14968800   ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
								16790707 / 55440,...
								-176498513 / 739200,...
								761142961 / 19958400   ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								108444169 / 2217600,...
								-323333323 / 19958400   ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
									2627203 / 1871100    ]'];

	smoothness_coeffs{5} = [    [    64361771 / 14968800,... 
								-295455983 / 6652800,...
								1894705391 / 19958400,...
							-1618284323 / 14968800,...
								115524053 / 1663200,...
								-95508139 / 3991680,...
									8279479 / 2395008    ]',...
							[           0.,...
								806338417 / 6652800,... 
							-3573798407 / 6652800,...
								1042531337 / 1663200,...
							-2725575317 / 6652800,... 
								475321093 / 3326400,...
								-15401629 / 739200       ]',...
							[            0.,...
											0.,...
								34187317 / 55440,... 
							-1476618887 / 997920,...
								1312114459 / 1330560,...
								-773749439 / 2217600,...
								256556849 / 4989600   ]',...
							[            0.,...
											0.,...
											0.,...
								2726585359 / 2993760,... 
								-412424029 / 332640,...
								2224538011 / 4989600,...
								-995600723 / 14968800     ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
								143270957 / 332640,...
							-2096571887 / 6652800,...
								105706999 / 2217600      ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								130013563 / 2217600,...
								-359321429 / 19958400     ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
									2627203 / 1871100      ]'];

	smoothness_coeffs{6} = [    [    62911297 / 2993760,...
							-4074544787 / 19958400,...
								2811067067 / 6652800,...
							-7124638253 / 14968800,...
								1531307249 / 4989600,...
								-712745603 / 6652800,...
								945155329 / 59875200     ]',...
							[            0.,...
								127942497 / 246400,...
							-14684933057 / 6652800,...
							12601009501 / 4989600,...
								-405382961 / 246400,...
								1924032511 / 3326400,...
								-341910757 / 3991680      ]',...
							[            0.,...
											0.,...
								796358777 / 332640,...
								-616410313 / 110880,...
								4868089189 / 1330560,...
							-8619440987 / 6652800,...
								320782183 / 1663200      ]',...
							[           0.,...
											0.,...
											0.,...
								9780057169 / 2993760,... 
							-4330640057 / 997920,...
								857838469 / 554400,...
							-3465607493 / 14968800     ]',...
							[            0.,...
											0.,...
											0.,...
											0.,...
								53678683 / 36960,...
							-6932480657 / 6652800,...
								3126718481 / 19958400     ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								1250007643 / 6652800,...
								-377474689 / 6652800      ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								64361771 / 14968800     ]'];

	smoothness_coeffs{7} = [[       897207163 / 7484400,... 
							-22763092357 / 19958400,...
							46808583631 / 19958400,...
							-39645439643 / 14968800,...
								8579309749 / 4989600,...
							-2416885043 / 3991680,...
								5391528799 / 59875200     ]',...
							[            0.,...
								6182612731 / 2217600,...
							-8623431623 / 739200,...
							66440049371 / 4989600,...
							-19308505679 / 2217600,...
								3417057367 / 1108800,...
							-9181961959 / 19958400     ]',...
							[            0.,...
											0.,...
								1369404749 / 110880,... 
							-28364892607 / 997920,...
								8290771913 / 443520,...
							-14734178999 / 2217600,...
								4964771899 / 4989600      ]',...
							[            0.,...
											0.,...
											0.,...
							49256859919 / 2993760,...
							-21693002767 / 997920,...
							38683385051 / 4989600,...
							-17425032203 / 14968800     ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
								199730921 / 27720,...
							-3809437823 / 739200,...
							15476926351 / 19958400     ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								2047941883 / 2217600,...
							-5556669277 / 19958400     ]',...
							[           0.,...
											0.,...
											0.,...
											0.,...
											0.,...
											0.,...
								62911297 / 2993760      ]'];

	% Create a block-diagonal matrix of smoothness coefficients
	if isempty(all_smooth)
		all_smooth = blkdiag(smoothness_coeffs{:});
	end
      
	m = 7;
	u_values = u_values';
	n_points = numel(u_idx);
	
	% Initialize the transposed flux-interpolation matrix.
	%
	wp = zeros(n, n_points);
	%
	% Normally it would be an (n_points x n) sized matrix, with each row 
	% interpolating the flux at x_{i-1/2} using function values at our 
	% grid points, but it's more efficient to construct it column-wise 
	% than row-wise, so we'll be operating on the transpose.
	% 
	
	% Initialize Smoothness Measurements
	ISp = zeros(1,m);
	nonlinear_values = zeros(m,m);


	
	% Generate stencil indices
	%
	stencils = zeros(m,m);
	stencils(:,1) = (1:m)';
	for i=2:m
		stencils(:,i) = stencils(:,i-1) + 1;
	end
	%
	% 'stencils' is an (m x m) matrix where each column contains the
	% relative indices (1;2;3..., 2,3,4....) for each stencil. 
	% 

	% 'local_flux_values' is a matrix used to collect the local flux
	% interpolation values so that they can easily be summed and
	% incorporated into a row of the global flux interpolation matrix.
	if isempty(local_flux_values)
		local_flux_values = zeros(m+(m-1));
		for i=1:m
			stencil_mapping(:, i) = sub2ind(size(local_flux_values), i*ones(1,m), (1:m)+(i-1));
		end
	end
	
	% Define a local index for our points
	j_absidx = 1;
	% 
	% 'j_absidx' references the local index of function values in 'u_values'
	% for constructing rows in the flux interpolation matrix.
	
	for j=u_idx
	
		% Get the global indices of the current point.
		window = (j-6:j+6)';
		
		% Get the corresponding function values.
		u = u_values(window);
		
		% Map the function values into local stencils.
		u_local = u(stencils);
		
		% Calculate the smoothness of each stencil.
		nonlinear_values(:) = (u_local(:).*(all_smooth*u_local(:)));
		ISp = sum(nonlinear_values,1);
		%
		% It's surprisingly efficient to just flatten 'u_local' and
		% multiply it by our block matrix of smoothness coefficients though
		% for higher-order weno methods the size of 'all_smooth' should
		% be taken into account and the matrix stored sparsely.
		% 
		
		% Calculate the normalized weights of each stencil.
		ISp = ideal_weights ./ (ISp + epsilon).^p;
		ISp = ISp ./ norm(ISp,1);
		%
		% norm(x,1) is noticably faster than sum(x) but
		% it should be noted that their results can differ
		% by what's hopefully just an insignificant rounding
		% error. If this is a problem, replace with:
		%
  		% IS = IS / sum(IS);  
  		% 

		% Apply those weights to each stencil.
		interp_coeffs = bsxfun(@times, stencil_coeffs, ISp);

		% Map global indices into our local stencils
		window_indices = window(stencils);

		% Update the global flux-interpolation matrix with our local stencils
		local_flux_values(stencil_mapping) = interp_coeffs;
		
		% Update the global flux-interpolation matrix
		wp(window_indices(1):window_indices(end), j_absidx) = sum(local_flux_values);
		
		% Move on to the next row of the global flux-interpolation matrix.
		j_absidx = j_absidx + 1;
	end
	
	% Return a correctly-transposed matrix.
	wp = wp';
end